{% extends "base.html" %}
{% load static %}
{% load currency_filters %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<!-- POS Layout Mejorado -->
<div class="min-h-screen bg-gray-100">
    <!-- Header del POS -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-full mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <img src="{% static 'images/logo-cantina-tita.png' %}" alt="La Cantina de Tita" class="h-12 w-auto mr-3">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Punto de Venta</h1>
                        <p class="text-sm text-gray-600">La Cantina de Tita</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Cajero: <span class="font-medium">{{ request.user.get_full_name|default:request.user.username }}</span></p>
                    <p class="text-sm text-gray-600">{{ "now"|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Panel de Productos (2/3) -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">üì¶ Productos Disponibles</h2>
                
                {% if productos %}
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        {% for producto in productos %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:shadow-md transition-all cursor-pointer transform hover:-translate-y-1"
                             onclick="agregarProductoCarrito({{ producto.id }}, '{{ producto.nombre|escapejs }}', {{ producto.precio_venta }})">
                            <div class="text-center">
                                <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-br from-blue-100 to-blue-200 rounded-full flex items-center justify-center">
                                    <span class="text-2xl">ÔøΩÔ∏è</span>
                                </div>
                                <h3 class="font-bold text-gray-900 mb-1">{{ producto.nombre }}</h3>
                                <p class="text-sm text-gray-600 mb-2">{{ producto.categoria.nombre }}</p>
                                <p class="text-xl font-bold text-green-600">{{ producto.precio_venta|guaranies }}</p>
                                {% if producto.requiere_stock %}
                                    <p class="text-xs text-gray-500">Stock: {{ producto.stock_actual }}</p>
                                {% else %}
                                    <p class="text-xs text-blue-500">üîÑ Sin l√≠mite</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-16">
                        <div class="text-6xl mb-4">üè™</div>
                        <h3 class="text-xl font-medium text-gray-600 mb-2">No hay productos disponibles</h3>
                        <p class="text-gray-500 mb-6">Agrega algunos productos para comenzar a vender</p>
                        <a href="{% url 'productos:crear_producto' %}" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-medium">
                            ‚ûï Agregar Producto
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Panel de Carrito (1/3) -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Header del Carrito -->
                <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-4">
                    <h2 class="text-xl font-bold">üõí Carrito de Compras</h2>
                </div>

                <!-- Items del Carrito -->
                <div class="p-4">
                    <div id="carrito-items" class="space-y-3 mb-4 max-h-80 overflow-y-auto">
                        <!-- Los items se agregar√°n din√°micamente aqu√≠ -->
                    </div>
                    
                    <div id="carrito-vacio" class="text-center py-12">
                        <span class="text-6xl">üõí</span>
                        <p class="text-gray-500 mt-4">Carrito vac√≠o</p>
                        <p class="text-sm text-gray-400">Selecciona productos para agregar</p>
                    </div>
                </div>

                <!-- Total y Acciones -->
                <div class="border-t bg-gray-50 p-4">
                    <!-- Total -->
                    <div class="bg-white border-2 border-green-500 rounded-lg p-4 text-center mb-4">
                        <div class="text-sm text-gray-600 mb-1">üí∞ TOTAL</div>
                        <div id="total-carrito" class="text-3xl font-bold text-green-600">Gs. 0</div>
                        <div id="contador-items" class="text-sm text-gray-500 mt-1">0 art√≠culos</div>
                    </div>

                    <!-- Botones -->
                    <div class="space-y-3">
                        <button id="btn-procesar-venta" onclick="procesarVentaCompleta()" disabled
                                class="w-full bg-green-500 text-white py-3 px-4 rounded-lg font-bold text-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                            üí≥ PROCESAR VENTA
                        </button>
                        <button onclick="vaciarCarritoCompleto()"
                                class="w-full bg-red-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-600 transition-colors">
                            üóëÔ∏è VACIAR CARRITO
                        </button>
                        <button onclick="window.location.href='{% url 'usuarios:dashboard' %}'"
                                class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-gray-600 transition-colors">
                            ‚Üê Volver al Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales del carrito
let carritoPos = [];
let totalVentaPos = 0;

console.log('üöÄ Iniciando POS - La Cantina de Tita...');

// Funci√≥n para formatear guaran√≠es paraguayos
function formatGuaraniesPos(valor) {
    if (!valor && valor !== 0) return 'Gs. 0';
    const numero = parseInt(valor);
    return 'Gs. ' + numero.toLocaleString('es-PY').replace(/,/g, '.');
}

// Funci√≥n para agregar producto al carrito
function agregarProductoCarrito(id, nombre, precio) {
    console.log('üì¶ Agregando producto al carrito:', { id, nombre, precio });
    
    // Verificar si el producto ya est√° en el carrito
    const productoExistente = carritoPos.find(item => item.id === id);
    
    if (productoExistente) {
        productoExistente.cantidad += 1;
        console.log('‚ûï Cantidad aumentada para:', nombre);
    } else {
        const nuevoProducto = {
            id: id,
            nombre: nombre,
            precio: parseFloat(precio),
            cantidad: 1
        };
        carritoPos.push(nuevoProducto);
        console.log('üÜï Nuevo producto agregado:', nuevoProducto);
    }
    
    actualizarCarritoCompleto();
    
    // Efecto visual de confirmaci√≥n
    mostrarNotificacion(`‚úÖ ${nombre} agregado al carrito`);
}

// Funci√≥n para remover producto del carrito
function removerProductoCarrito(id) {
    console.log('üóëÔ∏è Removiendo producto con ID:', id);
    const producto = carritoPos.find(item => item.id === id);
    if (producto) {
        console.log('üóëÔ∏è Producto removido:', producto.nombre);
    }
    carritoPos = carritoPos.filter(item => item.id !== id);
    actualizarCarritoCompleto();
}

// Funci√≥n para cambiar cantidad de un producto
function cambiarCantidadProducto(id, nuevaCantidad) {
    const producto = carritoPos.find(item => item.id === id);
    if (producto && nuevaCantidad > 0) {
        producto.cantidad = parseInt(nuevaCantidad);
        console.log('üìù Cantidad actualizada:', producto);
        actualizarCarritoCompleto();
    } else if (nuevaCantidad <= 0) {
        removerProductoCarrito(id);
    }
}

// Funci√≥n para actualizar todo el carrito
function actualizarCarritoCompleto() {
    console.log('üîÑ Actualizando carrito completo...');
    
    const carritoItems = document.getElementById('carrito-items');
    const carritoVacio = document.getElementById('carrito-vacio');
    const btnProcesar = document.getElementById('btn-procesar-venta');
    const totalDisplay = document.getElementById('total-carrito');
    const contadorItems = document.getElementById('contador-items');
    
    if (carritoPos.length === 0) {
        console.log('üõí El carrito est√° vac√≠o');
        carritoItems.innerHTML = '';
        carritoVacio.style.display = 'block';
        btnProcesar.disabled = true;
        totalVentaPos = 0;
    } else {
        console.log('üìã Carrito con', carritoPos.length, 'tipos de productos');
        carritoVacio.style.display = 'none';
        btnProcesar.disabled = false;
        
        let htmlCarrito = '';
        totalVentaPos = 0;
        let totalArticulos = 0;
        
        carritoPos.forEach(producto => {
            const subtotalProducto = producto.precio * producto.cantidad;
            totalVentaPos += subtotalProducto;
            totalArticulos += producto.cantidad;
            
            htmlCarrito += `
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-gray-900 text-sm">${producto.nombre}</h4>
                        <button onclick="removerProductoCarrito(${producto.id})" 
                                class="text-red-500 hover:text-red-700 text-sm px-1"
                                title="Eliminar producto">
                            ‚ùå
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <button onclick="cambiarCantidadProducto(${producto.id}, ${producto.cantidad - 1})"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-2 py-1 rounded text-xs">
                                -
                            </button>
                            <span class="text-sm font-medium px-2">${producto.cantidad}</span>
                            <button onclick="cambiarCantidadProducto(${producto.id}, ${producto.cantidad + 1})"
                                    class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-2 py-1 rounded text-xs">
                                +
                            </button>
                        </div>
                        <span class="font-bold text-green-600 text-sm">${formatGuaraniesPos(subtotalProducto)}</span>
                    </div>
                </div>
            `;
        });
        
        carritoItems.innerHTML = htmlCarrito;
    }
    
    // Actualizar displays
    totalDisplay.textContent = formatGuaraniesPos(totalVentaPos);
    contadorItems.textContent = `${totalArticulos} art√≠culo${totalArticulos !== 1 ? 's' : ''}`;
    
    console.log('üí∞ Total actualizado:', formatGuaraniesPos(totalVentaPos));
}

// Funci√≥n para vaciar el carrito completamente
function vaciarCarritoCompleto() {
    if (carritoPos.length > 0 && confirm('¬øEst√°s seguro de que deseas vaciar el carrito?')) {
        console.log('üßπ Vaciando carrito completo...');
        carritoPos = [];
        actualizarCarritoCompleto();
        mostrarNotificacion('üóëÔ∏è Carrito vaciado');
    }
}

// Funci√≥n para procesar la venta
function procesarVentaCompleta() {
    if (carritoPos.length === 0) {
        mostrarNotificacion('‚ö†Ô∏è El carrito est√° vac√≠o', 'warning');
        return;
    }
    
    console.log('üí≥ Procesando venta completa...');
    
    const resumenVenta = carritoPos.map(item => 
        `‚Ä¢ ${item.nombre} x${item.cantidad} = ${formatGuaraniesPos(item.precio * item.cantidad)}`
    ).join('\n');
    
    const mensaje = `üí≥ RESUMEN DE VENTA\n\n${resumenVenta}\n\nüí∞ TOTAL: ${formatGuaraniesPos(totalVentaPos)}\n\n¬øConfirmar venta?`;
    
    if (confirm(mensaje)) {
        // Aqu√≠ se implementar√≠a la l√≥gica real de procesamiento
        alert(`‚úÖ Venta procesada exitosamente!\n\nTotal: ${formatGuaraniesPos(totalVentaPos)}\n\n(En desarrollo: integraci√≥n con m√©todos de pago)`);
        carritoPos = [];
        actualizarCarritoCompleto();
    }
}

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'success') {
    console.log('üì¢ Notificaci√≥n:', mensaje);
    
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 transition-all duration-300 ${
        tipo === 'success' ? 'bg-green-500' : 'bg-yellow-500'
    }`;
    notificacion.textContent = mensaje;
    
    // Agregar al DOM
    document.body.appendChild(notificacion);
    
    // Remover despu√©s de 3 segundos
    setTimeout(() => {
        notificacion.style.opacity = '0';
        notificacion.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(notificacion)) {
                document.body.removeChild(notificacion);
            }
        }, 300);
    }, 3000);
}

// Inicializaci√≥n cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado completamente');
    actualizarCarritoCompleto();
    mostrarNotificacion('üéâ POS listo para operar!');
    console.log('üè™ Sistema POS inicializado correctamente');
});

// Manejo de errores globales
window.addEventListener('error', function(error) {
    console.error('‚ùå Error en POS:', error);
    mostrarNotificacion('‚ö†Ô∏è Error en el sistema', 'warning');
});
</script>
{% endblock %}